<?xml version="1.0" encoding="utf-8"?>
<Page
    x:Class="RcloneGui.Views.AddConnectionView"
    xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
    xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
    xmlns:local="using:RcloneGui.Views"
    xmlns:converters="using:RcloneGui.Converters"
    NavigationCacheMode="Disabled">
    
    <Page.Resources>
        <converters:BoolToVisibilityConverter x:Key="BoolToVisibility"/>
        <converters:AuthTypeToVisibilityConverter x:Key="AuthTypeToVisibility"/>
        <converters:StringToBoolConverter x:Key="StringToBoolConverter"/>
        <converters:InverseBoolConverter x:Key="InverseBoolConverter"/>
        <converters:BoolToSeverityConverter x:Key="BoolToSeverityConverter"/>
        <converters:BoolToTestTitleConverter x:Key="BoolToTestTitleConverter"/>
    </Page.Resources>
    
    <ScrollViewer>
        <StackPanel Padding="24" MaxWidth="600" HorizontalAlignment="Left">
            <!-- Header -->
            <TextBlock x:Name="PageTitle" Text="Add SFTP Connection" Style="{StaticResource TitleTextBlockStyle}"/>
            <TextBlock Text="Configure your SFTP server connection details" 
                       Style="{StaticResource CaptionTextBlockStyle}" 
                       Foreground="{ThemeResource TextFillColorSecondaryBrush}"
                       Margin="0,4,0,24"/>
            
            <!-- Connection Name -->
            <TextBlock Text="Connection Name" Style="{StaticResource BodyStrongTextBlockStyle}" Margin="0,0,0,8"/>
            <TextBox x:Name="NameBox" 
                     PlaceholderText="My SFTP Server"
                     Text="{x:Bind ViewModel.Name, Mode=TwoWay, UpdateSourceTrigger=PropertyChanged}"/>
            
            <!-- Server Settings -->
            <TextBlock Text="Server Settings" Style="{StaticResource SubtitleTextBlockStyle}" Margin="0,24,0,16"/>
            
            <Grid>
                <Grid.ColumnDefinitions>
                    <ColumnDefinition Width="*"/>
                    <ColumnDefinition Width="Auto"/>
                </Grid.ColumnDefinitions>
                <StackPanel Grid.Column="0" Margin="0,0,8,0">
                    <TextBlock Text="Host" Style="{StaticResource BodyStrongTextBlockStyle}" Margin="0,0,0,8"/>
                    <TextBox x:Name="HostBox" PlaceholderText="sftp.example.com"
                             Text="{x:Bind ViewModel.Host, Mode=TwoWay, UpdateSourceTrigger=PropertyChanged}"/>
                </StackPanel>
                <StackPanel Grid.Column="1" Width="100">
                    <TextBlock Text="Port" Style="{StaticResource BodyStrongTextBlockStyle}" Margin="0,0,0,8"/>
                    <NumberBox x:Name="PortBox" Value="{x:Bind ViewModel.Port, Mode=TwoWay}"
                               Minimum="1" Maximum="65535"
                               SpinButtonPlacementMode="Compact"/>
                </StackPanel>
            </Grid>
            
            <TextBlock Text="Username" Style="{StaticResource BodyStrongTextBlockStyle}" Margin="0,16,0,8"/>
            <TextBox x:Name="UsernameBox" PlaceholderText="username"
                     Text="{x:Bind ViewModel.Username, Mode=TwoWay, UpdateSourceTrigger=PropertyChanged}"/>
            
            <!-- Authentication -->
            <TextBlock Text="Authentication" Style="{StaticResource SubtitleTextBlockStyle}" Margin="0,24,0,16"/>
            
            <RadioButtons x:Name="AuthTypeRadio" SelectedIndex="0">
                <RadioButton Content="Password" Tag="Password" Checked="AuthType_Changed"/>
                <RadioButton Content="SSH Key" Tag="Key" Checked="AuthType_Changed"/>
            </RadioButtons>
            
            <!-- Password Authentication -->
            <StackPanel x:Name="PasswordPanel" Margin="0,16,0,0">
                <TextBlock Text="Password" Style="{StaticResource BodyStrongTextBlockStyle}" Margin="0,0,0,8"/>
                <PasswordBox PlaceholderText="Enter password"
                             Password="{x:Bind ViewModel.Password, Mode=TwoWay}"/>
            </StackPanel>
            
            <!-- SSH Key Authentication -->
            <StackPanel x:Name="KeyPanel" Visibility="Collapsed" Margin="0,16,0,0">
                <TextBlock Text="Private Key File" Style="{StaticResource BodyStrongTextBlockStyle}" Margin="0,0,0,8"/>
                <Grid>
                    <Grid.ColumnDefinitions>
                        <ColumnDefinition Width="*"/>
                        <ColumnDefinition Width="Auto"/>
                    </Grid.ColumnDefinitions>
                    <TextBox Grid.Column="0" 
                             PlaceholderText="Path to private key file"
                             Text="{x:Bind ViewModel.KeyFilePath, Mode=TwoWay}"
                             IsReadOnly="True"/>
                    <Button Grid.Column="1" Content="Browse" Margin="8,0,0,0" Click="BrowseKeyFile_Click"/>
                </Grid>
                
                <TextBlock Text="Key Passphrase (optional)" Style="{StaticResource BodyStrongTextBlockStyle}" Margin="0,16,0,8"/>
                <PasswordBox PlaceholderText="Enter passphrase if key is encrypted"
                             Password="{x:Bind ViewModel.KeyPassphrase, Mode=TwoWay}"/>
            </StackPanel>
            
            <!-- Mount Settings -->
            <TextBlock Text="Mount Settings" Style="{StaticResource SubtitleTextBlockStyle}" Margin="0,24,0,16"/>
            
            <TextBlock Text="Remote Path" Style="{StaticResource BodyStrongTextBlockStyle}" Margin="0,0,0,8"/>
            <TextBox PlaceholderText="/ (root) or /home/user"
                     Text="{x:Bind ViewModel.RemotePath, Mode=TwoWay, UpdateSourceTrigger=PropertyChanged}"/>
            
            <Grid Margin="0,16,0,0">
                <Grid.ColumnDefinitions>
                    <ColumnDefinition Width="*"/>
                    <ColumnDefinition Width="*"/>
                </Grid.ColumnDefinitions>
                
                <StackPanel Grid.Column="0" Margin="0,0,8,0">
                    <TextBlock Text="Drive Letter" Style="{StaticResource BodyStrongTextBlockStyle}" Margin="0,0,0,8"/>
                    <ComboBox ItemsSource="{x:Bind ViewModel.AvailableDriveLetters, Mode=OneWay}"
                              SelectedItem="{x:Bind ViewModel.SelectedDriveLetter, Mode=TwoWay}"
                              HorizontalAlignment="Stretch"/>
                </StackPanel>
                
                <StackPanel Grid.Column="1" Margin="8,0,0,0">
                    <TextBlock Text="Volume Name" Style="{StaticResource BodyStrongTextBlockStyle}" Margin="0,0,0,8"/>
                    <TextBox PlaceholderText="SFTP Drive"
                             Text="{x:Bind ViewModel.VolumeName, Mode=TwoWay, UpdateSourceTrigger=PropertyChanged}"/>
                </StackPanel>
            </Grid>
            
            <!-- Options -->
            <TextBlock Text="Options" Style="{StaticResource SubtitleTextBlockStyle}" Margin="0,24,0,16"/>
            
            <ToggleSwitch Header="Read-only mode" 
                          IsOn="{x:Bind ViewModel.ReadOnly, Mode=TwoWay}"
                          OffContent="Write access enabled"
                          OnContent="Read-only access"/>
            
            <ToggleSwitch Header="Network drive mode" 
                          IsOn="{x:Bind ViewModel.NetworkMode, Mode=TwoWay}"
                          OffContent="Shows as local drive"
                          OnContent="Shows as network drive"
                          Margin="0,8,0,0"/>
            
            <ToggleSwitch Header="Auto-mount on startup" 
                          IsOn="{x:Bind ViewModel.AutoMount, Mode=TwoWay}"
                          OffContent="Manual mount required"
                          OnContent="Mounts automatically"
                          Margin="0,8,0,0"/>
            
            <!-- Cache Settings -->
            <TextBlock Text="Cache Settings" Style="{StaticResource SubtitleTextBlockStyle}" Margin="0,24,0,16"/>
            
            <TextBlock Text="Cache Mode" Style="{StaticResource BodyStrongTextBlockStyle}" Margin="0,0,0,8"/>
            <ComboBox x:Name="CacheModeCombo" SelectedIndex="1" HorizontalAlignment="Stretch">
                <ComboBoxItem Content="Off - No caching"/>
                <ComboBoxItem Content="Minimal - Cache only metadata"/>
                <ComboBoxItem Content="Writes - Cache writes only"/>
                <ComboBoxItem Content="Full - Full file caching"/>
            </ComboBox>
            
            <TextBlock Text="Cache Size" Style="{StaticResource BodyStrongTextBlockStyle}" Margin="0,16,0,8"/>
            <TextBox PlaceholderText="10G"
                     Text="{x:Bind ViewModel.CacheMaxSize, Mode=TwoWay}"/>
            <TextBlock Text="Examples: 100M, 1G, 10G" 
                       Style="{StaticResource CaptionTextBlockStyle}"
                       Foreground="{ThemeResource TextFillColorSecondaryBrush}"
                       Margin="0,4,0,0"/>
            
            <!-- Error Message -->
            <InfoBar x:Name="ErrorInfoBar"
                     IsOpen="{x:Bind ViewModel.ErrorMessage, Mode=OneWay, Converter={StaticResource StringToBoolConverter}}"
                     Severity="Error"
                     Title="Error"
                     Message="{x:Bind ViewModel.ErrorMessage, Mode=OneWay}"
                     Margin="0,16,0,0"/>
            
            <!-- Test Result -->
            <InfoBar x:Name="TestResultInfoBar"
                     IsOpen="{x:Bind ViewModel.TestResult, Mode=OneWay, Converter={StaticResource StringToBoolConverter}}"
                     Severity="{x:Bind ViewModel.TestSuccess, Mode=OneWay, Converter={StaticResource BoolToSeverityConverter}}"
                     Title="{x:Bind ViewModel.TestSuccess, Mode=OneWay, Converter={StaticResource BoolToTestTitleConverter}}"
                     Message="{x:Bind ViewModel.TestResult, Mode=OneWay}"
                     Margin="0,8,0,0"/>
            
            <!-- Test & Save -->
            <Grid Margin="0,24,0,24">
                <Grid.ColumnDefinitions>
                    <ColumnDefinition Width="*"/>
                    <ColumnDefinition Width="Auto"/>
                    <ColumnDefinition Width="Auto"/>
                </Grid.ColumnDefinitions>
                
                <!-- Progress indicator -->
                <StackPanel Grid.Column="0" Orientation="Horizontal" VerticalAlignment="Center">
                    <ProgressRing IsActive="{x:Bind ViewModel.IsTesting, Mode=OneWay}" 
                                  Width="20" Height="20"
                                  Visibility="{x:Bind ViewModel.IsTesting, Mode=OneWay, Converter={StaticResource BoolToVisibility}}"/>
                    <TextBlock Text="Testing connection..." 
                               Margin="8,0,0,0" 
                               VerticalAlignment="Center"
                               Visibility="{x:Bind ViewModel.IsTesting, Mode=OneWay, Converter={StaticResource BoolToVisibility}}"/>
                    <ProgressRing IsActive="{x:Bind ViewModel.IsSaving, Mode=OneWay}" 
                                  Width="20" Height="20"
                                  Visibility="{x:Bind ViewModel.IsSaving, Mode=OneWay, Converter={StaticResource BoolToVisibility}}"/>
                    <TextBlock Text="Saving connection..." 
                               Margin="8,0,0,0" 
                               VerticalAlignment="Center"
                               Visibility="{x:Bind ViewModel.IsSaving, Mode=OneWay, Converter={StaticResource BoolToVisibility}}"/>
                </StackPanel>
                
                <Button Grid.Column="1" 
                        Content="Test Connection" 
                        Command="{x:Bind ViewModel.TestConnectionCommand}"
                        IsEnabled="{x:Bind ViewModel.IsTesting, Mode=OneWay, Converter={StaticResource InverseBoolConverter}}"
                        Margin="0,0,8,0"/>
                
                <Button Grid.Column="2" 
                        Content="Save Connection" 
                        Style="{StaticResource AccentButtonStyle}"
                        Command="{x:Bind ViewModel.SaveCommand}"
                        IsEnabled="{x:Bind ViewModel.IsSaving, Mode=OneWay, Converter={StaticResource InverseBoolConverter}}"
                        Click="SaveButton_Click"/>
            </Grid>
        </StackPanel>
    </ScrollViewer>
</Page>
